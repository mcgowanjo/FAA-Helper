<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Department Console — FAA • NTSB • Transit • Maritime</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --faa:#2563eb; --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --grid:#e5e7eb;
    --chip:#eef2ff; --chipInk:#1e3a8a; --ok:#2e7d32; --warn:#ef6c00; --panel:#fff; --codebg:#0b1020; --codefg:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"IBM Plex Sans Condensed",system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;padding:10px 16px;color:#fff;background:linear-gradient(90deg,var(--faa),#3b82f6)}
  .title{font-size:20px}
  .badge{background:var(--chip);color:var(--chipInk);border-radius:999px;padding:3px 10px;font-size:12px;margin-left:8px}
  .btn{border:0;border-radius:10px;padding:8px 12px;background:#1976d2;color:#fff;font-weight:600;cursor:pointer}
  .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn)}
  .tabs{display:flex;background:#e2e8f0;border-bottom:1px solid var(--grid)}
  .tabs button{flex:1;border:0;background:#e2e8f0;color:var(--ink);padding:12px;cursor:pointer}
  .tabs .active{background:#fff;font-weight:700;border-bottom:3px solid currentColor}
  .panel{display:none;padding:16px}.panel.active{display:block}

  /* Subtabs */
  .subtabs{margin:10px 0}
  .subtabs button{margin-right:6px;border:1px solid #93c5fd;background:#e0f2fe;color:#0c4a6e;padding:6px 10px;border-radius:8px;cursor:pointer}
  .subtabs .active{background:#bae6fd}

  .row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:10px}
  .row>div{flex:1 1 280px}
  label{display:block;margin:4px 0 4px;color:#344054;font-size:13px}
  .req::after{content:" *";color:#c62828;font-weight:700}
  input,select,textarea{width:100%;padding:9px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
  textarea{min-height:96px}
  .hint{color:var(--muted);font-size:12px}
  .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:12px}
  .code{background:var(--codebg);color:var(--codefg);border-radius:10px;padding:10px;white-space:pre-wrap;font-family:Consolas,monospace}
  .gate{border:1px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:16px;text-align:center}
  .errbox{display:none;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;border-radius:10px;padding:10px;margin:8px 0}
  .err{border-color:#e53935!important;box-shadow:0 0 0 3px rgba(229,57,53,.18)}
  ul.compact{margin:6px 0 0 18px}

  /* Keep things spacious so no “touching” inputs */
  .row>div > input, .row>div > select { margin-top:4px }

  /* Make app wide by default */
  .app{max-width:1600px;margin:0 auto}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">Department Console — FAA • NTSB • Transit • Maritime <span id="lockState" class="badge">Locked</span></div>
    <div>
      <input id="lockPass" type="password" placeholder="User code…"/>
      <button id="unlockBtn" class="btn ok">Unlock</button>
      <button id="lockBtn" class="btn warn">Lock</button>
    </div>
  </div>

  <div id="wrap">
    <!-- ================= FAA ================= -->
    <div id="faa" class="panel active">
      <div class="tabs">
        <button class="tab active" data-tab="faa_atc">Air Traffic Control (ATC)</button>
        <button class="tab" data-tab="faa_refs">References</button>
      </div>

      <!-- ATC (PROTECTED) -->
      <div id="faa_atc" class="panel active" data-protected="true">
        <div class="subtabs">
          <button class="sub active" data-sub="atis">ATIS</button>
          <button class="sub" data-sub="clearance">Clearance</button>
          <button class="sub" data-sub="gndtower">Ground / Tower / Center</button>
          <button class="sub" data-sub="pilot">Pilot Tools</button>
        </div>

        <!-- ATIS -->
        <div id="atis" class="subpanel">
          <h3>ATIS Generator (Statewide compact)</h3>
          <div class="row">
            <div><label class="req">Controller Name</label><select id="aName"></select></div>
            <div><label class="req">Position</label><select id="aPos"><option>Tower</option><option>Approach</option><option>Departure</option><option>Center</option></select></div>
            <div><label class="req">Time of Day</label><select id="aTod"><option value="">— Select —</option><option>Day</option><option>Night</option></select></div>
            <div><label class="req">Weather Preset</label>
              <select id="aWx"><option value="">— Select —</option><option value="CLEAR">Clear</option><option value="RAIN">Rain</option><option value="FOG">Fog</option><option value="WINDY">Windy</option><option value="OVERCAST">Overcast</option><option value="STORM">Storm</option></select>
            </div>
          </div>
          <div class="row">
            <div><label class="req">Wind Profile</label>
              <select id="aWindProfile"><option value="">— Select —</option><option value="CALM">Calm (000/00)</option><option value="LIGHT">Light (220/06)</option><option value="BREEZY">Breezy (230/12)</option><option value="WINDY">Windy (250/22G30)</option><option value="CROSS">Crosswind (090/18)</option><option value="CUSTOM">Custom…</option></select>
            </div>
            <div><label>Wind (auto)</label><input id="aWindAuto" disabled></div>
            <div><label>Visibility (auto)</label><input id="aVisAuto" disabled></div>
            <div><label>Clouds (auto)</label><input id="aCloudsAuto" disabled></div>
          </div>
          <div class="row" id="aCustomRow" style="display:none">
            <div><label class="req">Wind (ddd/ss[Ggg])</label><input id="aWind" placeholder="220/06"></div>
            <div><label class="req">Visibility (SM)</label><input id="aVis" placeholder="10"></div>
            <div><label class="req">Clouds</label><input id="aClouds" placeholder="SKC / SCT030 / BKN025 / OVC008"></div>
          </div>
          <div class="row">
            <div><label class="req">Global Ops Mode</label><select id="aOps"><option>Normal</option><option>Reverse</option></select></div>
            <div class="card">
              <label class="req">ATIS Letter</label>
              <div class="row" style="gap:10px;align-items:center">
                <input id="aLetter" disabled style="max-width:140px">
                <button class="btn" id="nextLetterBtn">Next Letter</button>
              </div>
              <div class="hint" style="text-align:right">Saved locally</div>
            </div>
            <div class="card">
              <label>Flags</label>
              <div>
                <label><input type="checkbox" id="aAllOk" checked> All airports operational</label><br/>
                <label><input type="checkbox" id="aNoise"> Noise abatement in effect</label><br/>
                <label><input type="checkbox" id="aInclClr" checked> Include “Contact Clearance 122.2”</label>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="card"><b>LSIA</b>
              <div class="row">
                <div><label><input type="checkbox" id="apLSIA_ok" checked> Operational</label></div>
                <div><label>Ops</label><select id="apLSIA_ops"><option value="">(Global)</option><option>Normal</option><option>Reverse</option></select></div>
                <div><label>Reason</label><select id="apLSIA_reason" disabled></select></div>
                <div><label>Note</label><input id="apLSIA_note" placeholder="(optional)" disabled></div>
              </div>
            </div>
            <div class="card"><b>SDSH</b>
              <div class="row">
                <div><label><input type="checkbox" id="apSDSH_ok" checked> Operational</label></div>
                <div><label>Ops</label><select id="apSDSH_ops"><option value="">(Global)</option><option>Normal</option><option>Reverse</option></select></div>
                <div><label>Reason</label><select id="apSDSH_reason" disabled></select></div>
                <div><label>Note</label><input id="apSDSH_note" placeholder="(optional)" disabled></div>
              </div>
            </div>
            <div class="card"><b>GPSD</b>
              <div class="row">
                <div><label><input type="checkbox" id="apGPSD_ok" checked> Operational</label></div>
                <div><label>Ops</label><select id="apGPSD_ops"><option value="">(Global)</option><option>Normal</option><option>Reverse</option></select></div>
                <div><label>Reason</label><select id="apGPSD_reason" disabled></select></div>
                <div><label>Note</label><input id="apGPSD_note" placeholder="(optional)" disabled></div>
              </div>
            </div>
            <div class="card"><b>PBAY</b>
              <div class="row">
                <div><label><input type="checkbox" id="apPBAY_ok" checked> Operational</label></div>
                <div><label>Ops</label><select id="apPBAY_ops"><option value="">(Global)</option><option>Normal</option><option>Reverse</option></select></div>
                <div><label>Reason</label><select id="apPBAY_reason" disabled></select></div>
                <div><label>Note</label><input id="apPBAY_note" placeholder="(optional)" disabled></div>
              </div>
            </div>
          </div>

          <div id="aErr" class="errbox"></div>
          <button id="btnATIS" class="btn ok">Generate ATIS — Click to copy, then paste in Skybox</button>
          <div id="atisOut" class="code"></div>
        </div>

        <!-- CLEARANCE (single form) -->
        <div id="clearance" class="subpanel" style="display:none">
          <h3>Clearance Delivery — Single Form</h3>
          <div class="row">
            <div><label class="req">Position</label><select id="clrPos"><option>Clearance Delivery</option><option>Ground</option></select></div>
            <div><label class="req">Type</label><select id="clrType"><option>IFR</option><option>VFR</option><option>Special Ops — Helicopter</option></select></div>
            <div><label class="req">Callsign</label><input id="clrCall" placeholder="N123AB / AIR-1 / LSX21"></div>
            <div><label class="req">Aircraft</label><input id="clrAcft" placeholder="A320 / C172 / AS350"></div>
          </div>

          <div class="row" id="clrIFRRow">
            <div><label class="req">Route (From → To)</label>
              <select id="clrRoute">
                <option>LSIA → SDSH</option><option>LSIA → PBAY</option><option>LSIA → GPSD</option>
                <option>SDSH → LSIA</option><option>SDSH → PBAY</option><option>SDSH → GPSD</option>
                <option>PBAY → LSIA</option><option>PBAY → SDSH</option><option>PBAY → GPSD</option>
                <option>GPSD → LSIA</option><option>GPSD → SDSH</option><option>GPSD → PBAY</option>
              </select>
            </div>
            <div><label>SID (auto)</label><input id="clrSid" disabled></div>
            <div><label>Initial Altitude (auto)</label><input id="clrInit" disabled></div>
            <div><label>Cruise Altitude (auto)</label><input id="clrCruise" disabled></div>
            <div><label>Departure Freq</label><input id="clrDepFreq" value="122.5"></div>
            <div><label>Squawk (auto)</label><input id="clrSquawk" disabled></div>
          </div>

          <div class="row" id="clrVFRRow" style="display:none">
            <div><label class="req">Departure</label><select id="vfrDep"><option>LSIA</option><option>SDSH</option><option>GPSD</option><option>PBAY</option></select></div>
            <div><label class="req">Direction</label><select id="vfrDir"><option>North</option><option>East</option><option>South</option><option>West</option></select></div>
            <div><label>Min Altitude (auto)</label><input id="vfrMin" disabled></div>
          </div>

          <div class="row" id="clrHeliRow" style="display:none">
            <div><label class="req">Department</label><select id="heliDept"><option>Police</option><option>EMS</option><option>Fire</option><option>Coast Guard</option></select></div>
            <div><label class="req">Departure</label><select id="heliDep"><option>LSIA</option><option>SDSH</option><option>GPSD</option><option>PBAY</option></select></div>
            <div><label class="req">Direction</label><select id="heliDir"><option>North</option><option>East</option><option>South</option><option>West</option></select></div>
            <div><label>Min Altitude (auto)</label><input id="heliMin" disabled></div>
            <div><label>Ops Area (auto)</label><input id="heliArea" disabled></div>
          </div>

          <div id="clrErr" class="errbox"></div>
          <button id="btnCLR" class="btn">Generate Clearance — Click to copy, then paste in Skybox</button>
          <div id="clrOut" class="code"></div>
        </div>

        <!-- GROUND / TOWER / CENTER -->
        <div id="gndtower" class="subpanel" style="display:none">
          <div class="row">
            <div class="card" style="flex:1 1 420px">
              <b>Ground</b>
              <div class="row">
                <button class="btn" data-g="/gme Pushback approved.">Pushback Approved</button>
                <button class="btn" data-g="/gme Pushback and start approved, advise when ready to taxi.">Push & Start</button>
                <button class="btn" data-g="/gme Start approved, advise when ready to taxi.">Start Only Approved</button>
                <button class="btn" data-g="/gme Taxi to RWY 24R via A-B, contact Tower 122.4 when ready for departure.">Taxi to Runway</button>
                <button class="btn" data-g="/gme Taxi to parking via A, monitor Ground 122.3.">Taxi to Parking</button>
              </div>
            </div>
            <div class="card" style="flex:1 1 420px">
              <b>Tower</b>
              <div class="row">
                <button class="btn" data-t="/gme Hold short RWY 24R.">Hold Short</button>
                <button class="btn" data-t="/gme Line up and wait RWY 24R.">Line Up & Wait</button>
                <button class="btn" data-t="/gme RWY 24R cleared for takeoff, contact Departure 122.5.">Cleared for Takeoff</button>
                <button class="btn" data-t="/gme RWY 24R cleared to land, wind 220/06.">Cleared to Land</button>
                <button class="btn" data-t="/gme Go around, fly runway heading, climb to pattern altitude, right traffic.">Go Around</button>
                <button class="btn" data-t="/gme Noise abatement in effect, after liftoff fly runway heading to 500 feet then left turn per published procedure.">Noise-Abatement Takeoff</button>
              </div>
            </div>
            <div class="card" style="flex:1 1 420px">
              <b>Center</b>
              <div class="row">
                <button class="btn" data-c="/gme Climb and maintain FL280.">Climb</button>
                <button class="btn" data-c="/gme Descend and maintain 1 2 thousand.">Descend</button>
                <button class="btn" data-c="/gme Fly heading 2 7 0, vectors westbound.">Heading</button>
                <button class="btn" data-c="/gme Proceed direct COAST.">Direct</button>
                <button class="btn" data-c="/gme Contact next sector on 122.7.">Handoff</button>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="card" style="flex:1 1 100%"><div id="gndtowerOut" class="code"></div></div>
          </div>
        </div>

        <!-- PILOT TOOLS -->
        <div id="pilot" class="subpanel" style="display:none">
          <h3>Pilot Quick Message</h3>
          <div class="row">
            <div><label class="req">Callsign</label><input id="plCall" placeholder="AIR-1 / MED-1 / N123AB"></div>
            <div><label class="req">Type</label><select id="plType"><option>IFR</option><option>VFR</option><option>Helicopter</option></select></div>
          </div>
          <button class="btn" id="plCopy">Click to copy → paste in Skybox (if no controller available)</button>
          <div id="pilotOut" class="code"></div>
        </div>
      </div>

      <!-- References (PUBLIC) -->
      <div id="faa_refs" class="panel" data-public="true">
        <h3>References</h3>
        <div class="grid2">
          <div class="card">
            <b>Frequencies</b>
            <ul class="hint compact">
              <li>ATIS 122.1</li>
              <li>Clearance 122.2</li>
              <li>Ground 122.3</li>
              <li>Tower 122.4</li>
              <li>Departure/Approach 122.5</li>
              <li>Center 122.7</li>
            </ul>
          </div>
          <div class="card">
            <b>Airports</b>
            <ul class="hint compact">
              <li>LSIA — Los Santos Intl</li>
              <li>SDSH — Sandy Shores Airfield</li>
              <li>GPSD — Grapeseed Airfield</li>
              <li>PBAY — Paleto Airpark</li>
            </ul>
          </div>
          <div class="card">
            <b>Phraseology</b>
            <ul class="hint compact">
              <li>“Climb and maintain 5,000”</li>
              <li>“Descend and maintain 1 2 thousand”</li>
              <li>“Proceed direct COAST”</li>
              <li>“Cleared for takeoff runway two four right”</li>
              <li>“Cleared to land runway two four right”</li>
            </ul>
          </div>
        </div>
      </div>
    </div><!-- /FAA -->
  </div><!-- /wrap -->
</div><!-- /app -->

<script>
/* ================= USERS / LOGIN ================= */
const USERS = {
  "john123":{name:'John', role:'Supervisor', enabled:true},
  "ava456": {name:'Ava',  role:'Controller', enabled:true},
  "mav789": {name:'Maverick', role:'Trainee', enabled:true},
};
let CURRENT_USER = null;

function lockState(){
  const tag = CURRENT_USER ? `Logged in as ${CURRENT_USER.name} (${CURRENT_USER.role})` : 'Locked';
  document.querySelector('#lockState').textContent = tag;
}
function unlockWith(code){
  const u = USERS[code];
  if(u && u.enabled){ CURRENT_USER = u; localStorage.setItem('APP_USER',code); lockState(); refreshGates(); initControllers(); }
  else alert('Incorrect code.');
}
function lockAll(){
  CURRENT_USER=null; localStorage.removeItem('APP_USER'); lockState(); refreshGates();
}
document.querySelector('#unlockBtn').onclick=()=>unlockWith(document.querySelector('#lockPass').value.trim());
document.querySelector('#lockBtn').onclick=lockAll;
(function(){ const saved=localStorage.getItem('APP_USER'); if(saved && USERS[saved]){ CURRENT_USER=USERS[saved]; } lockState(); refreshGates(); initControllers(); })();

/* ================= COMMON HELPERS ================= */
const q = s=>document.querySelector(s);
const qa = s=>[...document.querySelectorAll(s)];
const copy = txt => {
  try { if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(txt);
        else { const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); } }
  catch(e){ console.warn('Copy failed', e); }
};
const LETTERS = ["ALPHA","BRAVO","CHARLIE","DELTA","ECHO","FOXTROT","GOLF","HOTEL","INDIA","JULIETT","KILO","LIMA","MIKE","NOVEMBER","OSCAR","PAPA","QUEBEC","ROMEO","SIERRA","TANGO","UNIFORM","VICTOR","WHISKEY","XRAY","YANKEE","ZULU"];
const WX_PRESETS={ CLEAR:{vis:"10",clouds:"SKC"}, RAIN:{vis:"6",clouds:"BKN025"}, FOG:{vis:"2",clouds:"OVC008"}, WINDY:{vis:"8",clouds:"SCT030"}, OVERCAST:{vis:"8",clouds:"OVC015"}, STORM:{vis:"3",clouds:"BKN015"} };
const WIND_PROFILES={ CALM:"000/00", LIGHT:"220/06", BREEZY:"230/12", WINDY:"250/22G30", CROSS:"090/18" };
const REASONS=[{code:"STAFF",ui:"Staffing",gme:"airport closed due to staffing unavailability"},{code:"POWER",ui:"Power outage",gme:"airport closed due to power outage"},{code:"EMERG",ui:"Emergency response",gme:"airport closed for emergency operations"},{code:"SEC",ui:"Security",gme:"airport closed due to a security incident"},{code:"EQUIP",ui:"Mechanical/Equipment",gme:"airport closed due to essential equipment outage"},{code:"INC",ui:"Incursion",gme:"airport closed due to a runway incursion investigation"},{code:"EXC",ui:"Aircraft overrun",gme:"airport closed due to a runway excursion"},{code:"WXMIN",ui:"Weather below minima",gme:"airport closed due to weather below landing minima"},{code:"NOTAM",ui:"NOTAM closure",gme:"airport closed per NOTAM"},{code:"OTHER",ui:"Other…",gme:"{OTHER}"}];
const AIRPORTS=["LSIA","SDSH","GPSD","PBAY"];
const RUNWAYS={ LSIA:{Normal:"24L/24R",Reverse:"06L/06R"}, SDSH:{Normal:"30",Reverse:"12"}, GPSD:{Normal:"17",Reverse:"35"}, PBAY:{Normal:"26",Reverse:"08"} };
const ALTIMETERS={LSIA:"29.92", SDSH:"29.86", GPSD:"29.88", PBAY:"29.90"};
const INIT_ALT={LSIA:"5,000", SDSH:"7,000", GPSD:"6,000", PBAY:"6,000"};
const CRUISE={
  "LSIA→SDSH":"FL240","SDSH→LSIA":"FL240",
  "LSIA→PBAY":"FL280","PBAY→LSIA":"FL280",
  "LSIA→GPSD":"FL260","GPSD→LSIA":"FL260",
  "SDSH→PBAY":"FL260","PBAY→SDSH":"FL260",
  "SDSH→GPSD":"FL240","GPSD→SDSH":"FL240",
  "GPSD→PBAY":"FL260","PBAY→GPSD":"FL260"
};
const SIDMAP={
  "LSIA→SDSH":"Coast Two",
  "LSIA→PBAY":"Vinewood One",
  "LSIA→GPSD":"Port One",
  "SDSH→LSIA":"Desert One",
  "SDSH→PBAY":"Sonora Two",
  "SDSH→GPSD":"Desert One",
  "PBAY→LSIA":"Chiliad One",
  "PBAY→SDSH":"Coastline One",
  "PBAY→GPSD":"Chiliad One",
  "GPSD→LSIA":"Farm One",
  "GPSD→SDSH":"Farm One",
  "GPSD→PBAY":"Chiliad One"
};
const VFR_MIN={LSIA:1500,SDSH:1200,GPSD:1200,PBAY:1500};
const HELI_MIN={LSIA:800,SDSH:600,GPSD:600,PBAY:700};
const HELI_AREAS={
  LSIA:"Los Santos city limits and port complex",
  SDSH:"Sandy Shores town and Alamo Sea shoreline",
  GPSD:"Grapeseed farms and windmill ridge",
  PBAY:"Paleto Bay town and coastline"
};
const SQUAWK_BASE={LSIA:1001,SDSH:3037,GPSD:2001,PBAY:4020};
function zZulu(){ const d=new Date(); return String(d.getUTCHours()).padStart(2,'0')+String(d.getUTCMinutes()).padStart(2,'0')+'z'; }
function spokenThousands(nstr){
  const n=parseInt(String(nstr).replace(/[^\d]/g,''),10)||0;
  if(n%1000===0){ const k=n/1000; return (k>=10?String(k).split('').join(' '):String(k))+' thousand'; }
  return n.toLocaleString();
}

/* ================= PROTECTED GATE ================= */
function applyGate(panel){
  if(!panel) return;
  const isProtected = panel.dataset && panel.dataset.protected === 'true';
  if(!isProtected) return;
  const existing = panel.querySelector(':scope > .gate');
  if (CURRENT_USER){
    if (existing) existing.remove();
    return;
  }
  if (!existing){
    const g = document.createElement('div');
    g.className = 'gate';
    g.innerHTML = '<h4>Restricted Area</h4><div class="hint">Enter your personal code to unlock tools.</div>'
      + '<div class="row" style="justify-content:center"><input id="inlinePass" type="password" placeholder="User code…" style="max-width:200px"> '
      + '<button class="btn ok" id="inlineUnlock">Unlock</button></div>';
    panel.appendChild(g);
    g.querySelector('#inlineUnlock').addEventListener('click',()=>{
      const code = g.querySelector('#inlinePass').value.trim();
      unlockWith(code);
    });
  }
}
function refreshGates(){ qa('[data-protected="true"]').forEach(applyGate); }

/* ================= TOP TABS (FAA only here) ================= */
qa('#faa .tabs .tab').forEach(btn=>{
  btn.addEventListener('click', (ev)=>{
    qa('#faa .tabs .tab').forEach(b=>b.classList.remove('active'));
    qa('#faa > .panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab; q('#'+id).classList.add('active');
    applyGate(q('#'+id));
    ev.stopPropagation();
  }, {capture:true});
});

/* ================= ATC SUBTABS (robust) ================= */
(function(){
  function showATCSub(id){
    qa('#faa_atc > .subtabs .sub').forEach(x=>x.classList.remove('active'));
    qa('#faa_atc > .subpanel').forEach(p=>p.style.display='none');
    const btn = q(`#faa_atc > .subtabs .sub[data-sub="${id}"]`);
    const panel = q('#'+id);
    if(btn) btn.classList.add('active');
    if(panel) panel.style.display='block';
    applyGate(q('#faa_atc'));
  }
  qa('#faa_atc > .subtabs .sub').forEach(b=>{
    b.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); showATCSub(b.dataset.sub); }, {capture:true});
  });
  showATCSub('atis');
})();

/* ================= CONTROLLER LIST INIT ================= */
function initControllers(){
  const sel=q('#aName'); if(!sel) return;
  sel.innerHTML='';
  Object.values(USERS).filter(u=>u.enabled).forEach(u=>{
    const o=document.createElement('option'); o.value=u.name; o.textContent=`${u.name} — ${u.role}`; sel.appendChild(o);
  });
}

/* ================= ATIS ================= */
(function initATIS(){
  const saved = localStorage.getItem('ATIS_LETTER')||'ALPHA';
  if(q('#aLetter')) q('#aLetter').value = saved;

  // Reasons + toggle enable per airport
  const REASON_FIELDS = ['LSIA','SDSH','GPSD','PBAY'].map(ap=>({
    ok:q(`#ap${ap}_ok`), reason:q(`#ap${ap}_reason`), note:q(`#ap${ap}_note`)
  }));
  ['LSIA','SDSH','GPSD','PBAY'].forEach((ap,i)=>{
    const r=q(`#ap${ap}_reason`); if(r){
      r.innerHTML=''; const blank=document.createElement('option'); blank.value=''; blank.text='— Select reason —'; r.appendChild(blank);
      REASONS.forEach(rr=>{ const o=document.createElement('option'); o.value=rr.code; o.text=rr.ui; r.appendChild(o); });
    }
    const ok=q(`#ap${ap}_ok`), note=q(`#ap${ap}_note`);
    function flip(){ const dis=ok.checked; r.disabled=dis; note.disabled=dis; if(dis){ r.classList.remove('err'); note.classList.remove('err'); } }
    ok?.addEventListener('change',flip); flip();
  });

  const syncAuto=()=>{
    const wx=q('#aWx')?.value; const prof=q('#aWindProfile')?.value; const custom=(prof==='CUSTOM');
    q('#aCustomRow').style.display=custom?'flex':'none';
    q('#aWindAuto').value = custom?'':(WIND_PROFILES[prof]||'');
    const p=WX_PRESETS[wx]||{};
    q('#aVisAuto').value = custom?'':(p.vis||'');
    q('#aCloudsAuto').value = custom?'':(p.clouds||'');
  };
  ['#aWx','#aWindProfile'].forEach(s=>q(s)?.addEventListener('change',syncAuto)); syncAuto();

  q('#nextLetterBtn')?.addEventListener('click',()=>{
    const cur=(q('#aLetter').value||'ALPHA').toUpperCase();
    const i=(LETTERS.indexOf(cur)+1+LETTERS.length)%LETTERS.length;
    const nxt=LETTERS[i]; q('#aLetter').value=nxt; localStorage.setItem('ATIS_LETTER',nxt);
  });

  q('#aAllOk')?.addEventListener('change',e=>{
    const all=e.target.checked; ['LSIA','SDSH','GPSD','PBAY'].forEach(ap=>{
      const box=q('#ap'+ap+'_ok'); if(box){ box.checked=all; box.dispatchEvent(new Event('change')); }
    });
  });

  q('#btnATIS')?.addEventListener('click',()=>{
    if(!CURRENT_USER) return alert('Locked. Enter your code to unlock.');
    genATIS();
  });
})();

function setErrs(boxSel, msgs){
  const box=q(boxSel); if(!box) return;
  if(!msgs.length){ box.style.display='none'; box.innerHTML=''; return; }
  box.style.display='block'; box.innerHTML="<b>Fix these:</b><ul class='compact'>"+msgs.map(m=>`<li>${m}</li>`).join('')+"</ul>";
}

function genATIS(){
  const errs=[];
  const name=q('#aName')?.value||''; if(!name) errs.push('Controller Name');
  const pos=q('#aPos')?.value||''; if(!pos) errs.push('Position');
  const tod=q('#aTod')?.value||''; if(!tod) errs.push('Time of Day');
  const wx=q('#aWx')?.value||''; if(!wx) errs.push('Weather Preset');
  const windProf=q('#aWindProfile')?.value||''; if(!windProf) errs.push('Wind Profile');

  const custom=(windProf==='CUSTOM');
  const wind = custom ? (q('#aWind').value||'') : q('#aWindAuto').value;
  const vis  = custom ? (q('#aVis').value||'')  : q('#aVisAuto').value;
  const clouds = custom ? (q('#aClouds').value||'') : q('#aCloudsAuto').value;
  if(!wind) errs.push('Wind (custom/auto)');
  if(!vis) errs.push('Visibility (custom/auto)');
  if(!clouds) errs.push('Clouds (custom/auto)');

  const letter=(q('#aLetter').value||'ALPHA').toUpperCase();
  const opsGlobal=q('#aOps')?.value||'Normal';
  const allOk = q('#aAllOk')?.checked;
  const noise = q('#aNoise')?.checked;
  const inclClr = q('#aInclClr')?.checked;

  const per={};
  ['LSIA','SDSH','GPSD','PBAY'].forEach(ap=>{
    const ok=q('#ap'+ap+'_ok')?.checked;
    const op=q('#ap'+ap+'_ops')?.value||'';
    const rs=q('#ap'+ap+'_reason')?.value||'';
    const note=q('#ap'+ap+'_note')?.value||'';
    if(!ok && !rs) errs.push(ap+' reason required when not operational');
    per[ap]={ok, ops:op||opsGlobal, reason:rs, note};
  });

  if(errs.length){ setErrs('#aErr',errs); return; }
  setErrs('#aErr',[]);

  function opsText(ap){
    if(per[ap].ok) return `${ap} ${RUNWAYS[ap][per[ap].ops]} active`;
    const r=REASONS.find(x=>x.code===per[ap].reason);
    const why = r ? r.gme.replace('{OTHER}', per[ap].note||'unspecified reason') : 'closed';
    return `${ap} CLOSED — ${why}${per[ap].note?` (${per[ap].note})`:''}`;
  }
  const opsLine = ['LSIA','SDSH','GPSD','PBAY'].map(opsText).join(', ');
  const alti = ['LSIA','SDSH','GPSD','PBAY'].map(ap=>`${ap} ${ALTIMETERS[ap]}`).join(', ');
  const z=zZulu();
  const out = [
    `/gme ${name} (${pos}) updates ATIS — Information ${letter}.`,
    `Winds ${wind}, vis ${vis}SM, clouds ${clouds}. ${tod}.`,
    `Runway ops: ${opsLine}.`,
    noise ? `Noise abatement in effect; comply with published procedures.` : ``,
    `Altimeter ${alti}.`,
    (inclClr?`Contact Clearance 122.2.`:``),
    `Advise on initial contact you have ${letter}. Time ${z}.`
  ].filter(Boolean).join(' ');
  q('#atisOut').textContent=out; copy(out);
}

/* ================= CLEARANCE (single form) ================= */
function routePieces(route){ const [from,to] = route.split('→').map(s=>s.trim()); return {from,to}; }
function nextSquawk(dep){
  const key='SQ_'+dep;
  let cur=parseInt(localStorage.getItem(key)||SQUAWK_BASE[dep]||1001,10);
  const next=cur+1; localStorage.setItem(key,String(next));
  return String(cur).padStart(4,'0');
}
function previewSquawk(dep){
  const key='SQ_'+dep;
  let cur=parseInt(localStorage.getItem(key)||SQUAWK_BASE[dep]||1001,10);
  return String(cur).padStart(4,'0');
}

function syncClrView(){
  const t=q('#clrType').value;
  q('#clrIFRRow').style.display = (t==='IFR')?'flex':'none';
  q('#clrVFRRow').style.display = (t==='VFR')?'flex':'none';
  q('#clrHeliRow').style.display = (t==='Special Ops — Helicopter')?'flex':'none';
}
q('#clrType').addEventListener('change', syncClrView); syncClrView();

function updateIFRAutos(){
  if(q('#clrType').value!=='IFR') return;
  const {from,to}=routePieces(q('#clrRoute').value);
  q('#clrSid').value = SIDMAP[q('#clrRoute').value] || 'As assigned';
  q('#clrInit').value = INIT_ALT[from] || '';
  q('#clrCruise').value = CRUISE[q('#clrRoute').value] || 'FL240';
  q('#clrSquawk').value = previewSquawk(from);
}
q('#clrRoute').addEventListener('change', updateIFRAutos); updateIFRAutos();

function updateVFRMin(){
  if(q('#clrType').value!=='VFR') return;
  const dep=q('#vfrDep').value; q('#vfrMin').value = VFR_MIN[dep] ? `${VFR_MIN[dep]} AGL` : '';
}
q('#vfrDep').addEventListener('change', updateVFRMin); updateVFRMin();

function updateHeliAutos(){
  if(q('#clrType').value!=='Special Ops — Helicopter') return;
  const dep=q('#heliDep').value;
  q('#heliMin').value = HELI_MIN[dep] ? `${HELI_MIN[dep]} AGL` : '';
  q('#heliArea').value = HELI_AREAS[dep] || '';
}
q('#heliDep').addEventListener('change', updateHeliAutos); updateHeliAutos();

function markError(el, on){ if(!el) return; if(on) el.classList.add('err'); else el.classList.remove('err'); }

q('#btnCLR').addEventListener('click', ()=>{
  if(!CURRENT_USER) return alert('Locked. Enter your code to unlock.');

  const errs=[];
  const pos=q('#clrPos').value;
  const type=q('#clrType').value;
  const call=q('#clrCall').value.trim();
  const acft=q('#clrAcft').value.trim();

  markError(q('#clrCall'), !call);
  markError(q('#clrAcft'), !acft);
  if(!call) errs.push('Callsign');
  if(!acft) errs.push('Aircraft');

  let out='';
  if(type==='IFR'){
    const route=q('#clrRoute').value; const {from,to}=routePieces(route);
    if(!from||!to) errs.push('Route');
    markError(q('#clrRoute'), !from||!to);
    if(errs.length){ setErrs('#clrErr',errs); return; } setErrs('#clrErr',[]);

    const sid=q('#clrSid').value || 'assigned SID';
    const init=q('#clrInit').value || '5,000';
    const cruise=q('#clrCruise').value || 'FL240';
    const depFreq=q('#clrDepFreq').value || '122.5';
    const squawk=nextSquawk(from);

    out = `/gme ${pos} issues clearance to ${call}. Cleared to ${to} via ${sid}, then as filed; maintain ${init} (${spokenThousands(init)}), expect ${cruise} 10 minutes after departure; departure frequency ${depFreq}; squawk ${squawk}.`;
  } else if(type==='VFR'){
    const dep=q('#vfrDep').value; const dir=q('#vfrDir').value;
    markError(q('#vfrDep'), !dep); markError(q('#vfrDir'), !dir);
    if(!dep) errs.push('Departure (VFR)'); if(!dir) errs.push('Direction (VFR)');
    if(errs.length){ setErrs('#clrErr',errs); return; } setErrs('#clrErr',[]);

    const min = `${VFR_MIN[dep]} AGL`;
    const landmarks = {
      LSIA:{North:"Vespucci / Downtown",East:"La Mesa / Freeway",South:"Port / Coastline",West:"Del Perro / Coast"},
      SDSH:{North:"Alamo Sea / Grape Corridor",East:"Grand Senora / Power Station",South:"Harmony / Prison",West:"Zancudo River / Canyons"},
      GPSD:{North:"Chiliad foothills",East:"County line",South:"Grape farms / Windmills",West:"Alamo Sea"},
      PBAY:{North:"Coast / County line",East:"Mount Chiliad ridge",South:"Zancudo area",West:"Open water"}
    };
    const ref=(landmarks[dep] && landmarks[dep][dir])?landmarks[dep][dir]:'assigned sector';
    out = `/gme ${pos} issues clearance to ${call}. VFR ${dir.toLowerCase()}bound from ${dep}; remain clear of ${ref}; maintain ${min}; departure 122.5.`;
  } else { // Heli
    const dept=q('#heliDept').value; const dep=q('#heliDep').value; const dir=q('#heliDir').value;
    markError(q('#heliDept'), !dept); markError(q('#heliDep'), !dep); markError(q('#heliDir'), !dir);
    if(!dept) errs.push('Department (Heli)'); if(!dep) errs.push('Departure (Heli)'); if(!dir) errs.push('Direction (Heli)');
    if(errs.length){ setErrs('#clrErr',errs); return; } setErrs('#clrErr',[]);

    const min = `${HELI_MIN[dep]} AGL`;
    const area = HELI_AREAS[dep] || 'assigned area';
    out = `/gme ${pos} issues clearance to ${call}. ${dept} helicopter, cleared ${dir.toLowerCase()} sector within ${area}; operate at or above ${min}; contact Departure 122.5.`;
  }

  q('#clrOut').textContent = out; copy(out);
});

/* ================= GROUND/TOWER/CENTER QUICK ================= */
function quickMsg(txt){ q('#gndtowerOut').textContent = txt; copy(txt); }
qa('#gndtower [data-g]').forEach(b=>b.addEventListener('click',()=>{ if(!CURRENT_USER) return alert('Locked. Enter your code.'); quickMsg(b.getAttribute('data-g')); }));
qa('#gndtower [data-t]').forEach(b=>b.addEventListener('click',()=>{ if(!CURRENT_USER) return alert('Locked. Enter your code.'); quickMsg(b.getAttribute('data-t')); }));
qa('#gndtower [data-c]').forEach(b=>b.addEventListener('click',()=>{ if(!CURRENT_USER) return alert('Locked. Enter your code.'); quickMsg(b.getAttribute('data-c')); }));

/* ================= PILOT TOOLS ================= */
q('#plCopy').addEventListener('click',()=>{
  const c=q('#plCall').value.trim()||'CALLSIGN';
  const t=q('#plType').value;
  const msg=`/gme Click to copy — pilot use only if no controller available: Pilot of ${c} ${t} ready to copy.`;
  q('#pilotOut').textContent=msg; copy(msg);
});

/* ================= ATIS DYNAMIC WIRING AFTER LOGIN ================= */
(function wireATIS(){
  // show/hide custom rows and auto fields already set in init
})();

</script>
</body>
</html>
